# 클로저
클로저는 자바스크립트에서만 사용되는 개념이 아니다. 함수를 일급 객체로 취급하는 함수형 프로그래밍 언어에서 사용되는 중요한 특성이다.

MDN에서는 클로저에 대해 다음과 같이 정의하고 있다.
> 클로저는 함수와 그 함수가 선언된 렉시컬 환경과의 조합이다.

### 함수가 선언된 렉시컬 환경?

자바스크립트 엔진은 함수를 어디서 호출했는지가 아니라, 함수를 어디에 정의했는지에 따라 상위 스코프를 결정한다. 

스코프의 실체는, 실행 컨텍스트의 렉시컬 환경이다. 이 렉시컬 환경은 `환경레코드`와 `외부 렉시컬 환경에 대한 참조`로 구성된다.

이 때, `외부 렉시컬 환경에 대한 참조`를 통해 상위 렉시컬 환경과 연결되며, 이것이 스코프 체인을 형성한다.
**상위 렉시컬 환경과 연결되는 작업은 함수 정의가 평가되는 시점에 함수가 정의된 환경에 의해 결정된다.**

## 함수 객체 내부 슬롯 [[Environment]]

함수가 정의된 환경과 함수가 호출되는 환경은 다를 수 있다. 
따라서 함수는 자신이 호출되는 환경과는 상관없이 자신의 상위 스코프를 기억하고 있어야 한다. 그래야 식별자 검색을 할 수 있기 때문이다.

이를 위해 함수는 자신의 내부 슬롯 `[[Environment]]`에 자신의 상위 스코프에 대한 참조를 저장한다. 
이는 함수의 정의가 평가되며 함수 객체가 생성될 때 수행되며, 내부 슬롯 `[[Environment]]`에 저장되는 값은 그 당시 실행 중인 
실행 컨텍스트의 렉시컬 환경을 가리킨다.
> 예를 들어, 전역에서 정의된 함수 선언문은 전역 코드가 실행될 때 평가된다. 따라서 전역 함수의 내부 슬롯 [[Envirionment]]에 저장되는 값은
> 현재 실행 중인 전역 실행 컨텍스트의 렉시컬 환경의 참조이다.

그리고 이 내부 슬롯의 값이, 이후 자신이 호출되었을 때 생성할 `함수 렉시컬 환경`의 `외부 렉시컬 환경에 대한 참조` 값에 들어가게 된다.

따라서 어디에서 함수가 호출이 되든 각 함수 객체는 자신이 정의된 환경, 자신의 상위 스코프를 참조할 수 있다.

## 자바스크립트에서의 클로저

**상위 스코프의 식별자를 참조하는 중첩 함수가 외부 함수보다 더 오래 유지되는 경우, 이러한 중첩 함수를 `클로저`라고 부른다.**

- 외부 함수가 종료되면 실행 컨텍스트 스택에서 제거된다.
- 하지만 외부 함수의 렉시컬 환경까지 사라지는 것은 아니다.
- 외부 함수가 먼저 종료된다고 해도, **중첩 함수는 외부 렉시컬 환경에 대한 참조를 통해 외부 함수의 식별자를 유지하여 참조할 수 있다.**

> (*) 모던 자바스크립트 엔진은 최적화를 통해 클로저가 참조하고 있지 않은 식별자는 기억하지 않는다.
